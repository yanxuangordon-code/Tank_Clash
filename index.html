<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TANK CLASH ONLINE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=VT323&display=swap');
:root{--gold:#ffd700;--red:#ff4040;--blue:#40c8ff;--green:#40ff80;--bg:#07070f;--border:rgba(255,255,255,0.09);}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'VT323',monospace;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,0.018) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.018) 1px,transparent 1px);background-size:36px 36px;animation:gm 22s linear infinite;pointer-events:none;z-index:0;}
@keyframes gm{from{background-position:0 0}to{background-position:0 36px}}
#app{position:relative;z-index:1;width:100%;max-width:980px;display:flex;flex-direction:column;align-items:center;}
.screen{display:none;flex-direction:column;align-items:center;width:100%;}.screen.active{display:flex;}
.game-title{font-family:'Black Ops One',cursive;font-size:54px;letter-spacing:6px;background:linear-gradient(135deg,var(--red),var(--gold),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 24px rgba(255,215,0,0.5));animation:pulse 3s ease-in-out infinite;margin-bottom:4px;}
.tagline{font-size:13px;letter-spacing:8px;color:#444;margin-bottom:24px;}
@keyframes pulse{0%,100%{filter:drop-shadow(0 0 14px rgba(255,215,0,0.3))}50%{filter:drop-shadow(0 0 40px rgba(255,215,0,0.8))}}
.lobby-card{width:500px;display:flex;flex-direction:column;align-items:center;gap:14px;}
.row2{display:flex;gap:16px;width:100%;}
.field{flex:1;display:flex;flex-direction:column;gap:6px;}
.field label{font-size:10px;letter-spacing:4px;color:#444;}
.field input{background:rgba(255,255,255,0.04);border:1px solid var(--border);color:#fff;font-family:'VT323',monospace;font-size:20px;letter-spacing:2px;padding:10px 14px;outline:none;width:100%;transition:border-color .2s;}
.field input:focus{border-color:var(--gold);}
.colors{display:flex;gap:10px;flex-wrap:wrap;padding-top:4px;}
.cdot{width:30px;height:30px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .18s;}
.cdot.on{border-color:#fff;transform:scale(1.25);}
.sv-row{display:flex;gap:12px;width:100%;}
.sv{flex:1;padding:16px 8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);cursor:pointer;text-align:center;transition:all .2s;position:relative;}
.sv:hover,.sv.on{border-color:var(--gold);box-shadow:0 0 20px rgba(255,215,0,0.18);transform:translateY(-2px);background:rgba(255,215,0,0.04);}
.sv-flag{font-size:24px;margin-bottom:4px;}
.sv-name{font-family:'Black Ops One',cursive;font-size:11px;letter-spacing:2px;color:var(--gold);margin-bottom:6px;}
.sv-cnt{font-size:20px;}
.sv-bar{height:4px;background:rgba(255,255,255,0.06);margin-top:6px;border-radius:2px;overflow:hidden;}
.sv-fill{height:100%;border-radius:2px;}
.sv-tick{position:absolute;top:5px;right:7px;font-size:10px;color:var(--gold);display:none;}
.sv.on .sv-tick{display:block;}
.btn{background:transparent;cursor:pointer;font-family:'Black Ops One',cursive;font-size:14px;letter-spacing:4px;padding:13px 40px;border:2px solid var(--gold);color:var(--gold);text-shadow:0 0 10px var(--gold);box-shadow:0 0 20px rgba(255,215,0,0.1);transition:all .2s;}
.btn:hover:not(:disabled){background:rgba(255,215,0,0.08);box-shadow:0 0 40px rgba(255,215,0,0.4);transform:scale(1.04);}
.btn:disabled{opacity:.28;cursor:not-allowed;}
.btn-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
.btn-sm{padding:10px 24px;font-size:12px;}
#lstat{min-height:18px;font-size:13px;letter-spacing:2px;text-align:center;color:#555;}
#lstat.ok{color:var(--green);text-shadow:0 0 8px var(--green);}
#lstat.err{color:var(--red);text-shadow:0 0 8px var(--red);}
#lstat.wait{color:var(--gold);text-shadow:0 0 8px var(--gold);}
/* COIN DISPLAY */
#coin-display{font-family:'Black Ops One',cursive;font-size:18px;color:var(--gold);text-shadow:0 0 10px var(--gold);letter-spacing:2px;}
/* SHOP */
#shop-screen .game-title{font-size:38px;margin-bottom:6px;}
.shop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;width:100%;max-width:820px;margin:16px 0;}
.tank-card{background:rgba(255,255,255,0.03);border:2px solid var(--border);padding:16px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.tank-card:hover{border-color:rgba(255,215,0,0.4);background:rgba(255,215,0,0.04);}
.tank-card.owned{border-color:var(--green);background:rgba(64,255,128,0.04);}
.tank-card.selected{border-color:var(--gold);box-shadow:0 0 20px rgba(255,215,0,0.25);background:rgba(255,215,0,0.06);}
.tank-card.locked{opacity:.55;cursor:not-allowed;}
.tc-name{font-family:'Black Ops One',cursive;font-size:14px;letter-spacing:3px;margin-bottom:8px;}
.tc-canvas{display:block;margin:0 auto 10px;}
.tc-stat{font-size:11px;color:#555;letter-spacing:1px;margin:3px 0;display:flex;align-items:center;gap:6px;}
.tc-bar{flex:1;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;}
.tc-bar-fill{height:100%;border-radius:2px;}
.tc-abilities{font-size:11px;color:#888;letter-spacing:1px;margin-top:8px;min-height:28px;}
.tc-price{font-family:'Black Ops One',cursive;font-size:16px;color:var(--gold);margin-top:10px;}
.tc-badge{position:absolute;top:6px;right:8px;font-size:10px;letter-spacing:1px;padding:2px 6px;}
.badge-owned{color:var(--green);}
.badge-sel{color:var(--gold);}
/* GAME HUD */
#game-wrap{position:relative;display:flex;flex-direction:column;align-items:center;}
#hud{width:820px;height:54px;display:flex;align-items:center;background:rgba(0,0,0,0.9);border:1px solid var(--border);border-bottom:none;padding:0 8px;gap:6px;}
.phud{width:160px;flex-shrink:0;padding:3px 6px;}
.phud .pname{font-family:'Black Ops One',cursive;font-size:10px;letter-spacing:2px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hp-wrap{height:6px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden;}
.hp-fill{height:100%;border-radius:3px;transition:width .12s;}
#hud-mid{flex:1;text-align:center;}
#hud-score{font-family:'Black Ops One',cursive;font-size:11px;letter-spacing:1px;color:var(--gold);text-shadow:0 0 10px var(--gold);line-height:1.3;}
#hud-room{font-size:9px;letter-spacing:2px;color:#1a1a2a;margin-top:1px;}
#hud-coins-live{font-size:13px;color:var(--gold);letter-spacing:1px;}
#hud-lead{width:200px;flex-shrink:0;display:flex;flex-direction:column;justify-content:center;gap:1px;padding:2px 6px;border-left:1px solid rgba(255,255,255,0.06);}
.lead-row{display:flex;align-items:center;gap:4px;font-size:10px;line-height:1.5;}
.lead-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.lead-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lead-kills{color:var(--gold);font-family:'Black Ops One',cursive;font-size:9px;flex-shrink:0;}
canvas#c{display:block;border:1px solid var(--border);box-shadow:0 0 60px rgba(0,0,0,0.9);}
#go{position:absolute;top:54px;left:50%;transform:translateX(-50%);width:820px;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:10;backdrop-filter:blur(4px);}
#go.hide{display:none;}
.spinner{width:40px;height:40px;border:3px solid rgba(255,215,0,0.15);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:14px;}
@keyframes spin{to{transform:rotate(360deg)}}
.dot-anim::after{content:'';animation:dots 1.4s steps(4,end) infinite;}
@keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}100%{content:''}}
#plist{width:360px;display:flex;flex-direction:column;gap:5px;max-height:180px;overflow-y:auto;margin-bottom:16px;}
.pr{display:flex;align-items:center;gap:10px;padding:6px 10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);}
.pr-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.pr-nick{font-size:16px;letter-spacing:2px;flex:1;}
.pr-you{font-size:10px;letter-spacing:2px;color:#333;}
.pr-sc{font-size:14px;color:#555;}
#chat{position:absolute;bottom:8px;left:8px;width:200px;z-index:5;}
#chat-log{display:flex;flex-direction:column;gap:2px;max-height:90px;overflow-y:auto;margin-bottom:4px;}
.cm{font-size:12px;padding:2px 5px;background:rgba(0,0,0,0.75);border-left:2px solid #222;letter-spacing:1px;}
#chat-row{display:flex;gap:3px;}
#ci{flex:1;background:rgba(0,0,0,0.7);border:1px solid #1a1a1a;color:#fff;font-family:'VT323',monospace;font-size:13px;padding:3px 6px;outline:none;}
#ci:focus{border-color:#333;}
#cs{background:transparent;border:1px solid #1a1a1a;color:#444;font-family:'VT323',monospace;font-size:13px;padding:3px 7px;cursor:pointer;}
#cs:hover{color:#888;}
#kf{position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:3px;z-index:5;pointer-events:none;}
.kfe{font-size:13px;padding:3px 10px;background:rgba(0,0,0,0.82);border-right:2px solid #f44;letter-spacing:1px;text-align:right;animation:kfi .3s ease;}
@keyframes kfi{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:none}}
#minimap-canvas{position:absolute;bottom:8px;right:8px;border:1px solid rgba(255,255,255,0.08);z-index:5;}
#ctrl-tip{position:absolute;bottom:96px;right:8px;font-size:9px;color:#1a1a28;letter-spacing:1px;text-align:right;line-height:1.9;z-index:5;}
#death-screen{position:absolute;top:54px;left:50%;transform:translateX(-50%);width:820px;bottom:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.72);z-index:8;pointer-events:none;}
#death-msg{font-family:'Black Ops One',cursive;font-size:26px;letter-spacing:4px;color:var(--red);text-shadow:0 0 20px var(--red);}
#death-timer{font-size:20px;letter-spacing:4px;color:#555;margin-top:8px;}
/* ability icons */
#ability-bar{position:absolute;bottom:8px;left:218px;display:flex;gap:8px;z-index:5;}
.ab-slot{width:44px;height:44px;background:rgba(0,0,0,0.75);border:2px solid rgba(255,255,255,0.1);display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:18px;position:relative;}
.ab-slot .ab-key{position:absolute;bottom:1px;right:2px;font-size:9px;color:#444;}
.ab-cd{position:absolute;inset:0;background:rgba(0,0,0,0.65);display:flex;align-items:center;justify-content:center;font-size:11px;color:#888;}
</style>
</head>
<body>
<div id="app">

<!-- â•â•â• LOBBY â•â•â• -->
<div id="lobby-screen" class="screen active">
  <div class="game-title">TANK CLASH</div>
  <div class="tagline">ONLINE PvP â€” UP TO 8 PLAYERS</div>
  <div style="margin-bottom:8px;"><span id="coin-display">ğŸª™ 0</span></div>
  <div class="lobby-card">
    <div class="row2">
      <div class="field" style="flex:1.4">
        <label>YOUR NICKNAME</label>
        <input id="nick" maxlength="12" placeholder="ACE" value="Player"/>
        <div id="nick-err" style="font-size:12px;color:var(--red);min-height:16px;letter-spacing:1px;"></div>
      </div>
      <div class="field"><label>TANK COLOR</label><div class="colors" id="colors"></div></div>
    </div>
    <div style="font-size:10px;letter-spacing:4px;color:#2a2a38;width:100%;text-align:left;">PICK A SERVER</div>
    <div class="sv-row" id="svgrid"></div>
    <div id="lstat" class="wait">Connecting<span class="dot-anim"></span></div>
    <div class="btn-row">
      <button class="btn" id="join-btn" disabled onclick="doJoin()">âš” JOIN BATTLE</button>
      <button class="btn btn-sm" onclick="showScreen('shop-screen');renderShop()">ğŸ›’ SHOP</button>
    </div>
    <div style="font-size:11px;color:#1a1a28;letter-spacing:2px;">WASD/ARROWS â€” MOVE &nbsp;|&nbsp; SPACE â€” FIRE</div>
  </div>
</div>

<!-- â•â•â• SHOP â•â•â• -->
<div id="shop-screen" class="screen">
  <div class="game-title" style="font-size:38px;margin-bottom:4px;">TANK SHOP</div>
  <div style="font-size:13px;color:#444;letter-spacing:3px;margin-bottom:4px;">BUY AND EQUIP TANKS</div>
  <div style="margin-bottom:12px;"><span id="shop-coins">ğŸª™ 0</span></div>
  <div class="shop-grid" id="shop-grid"></div>
  <button class="btn btn-sm" onclick="showScreen('lobby-screen')">â† BACK</button>
</div>

<!-- â•â•â• GAME â•â•â• -->
<div id="game-screen" class="screen">
  <div id="game-wrap">
    <div id="hud">
      <div class="phud"><div class="pname" id="h-left">YOU</div><div class="hp-wrap"><div class="hp-fill" id="hp-left" style="width:100%"></div></div></div>
      <div id="hud-mid">
        <div id="hud-score">â€”</div>
        <div id="hud-room">SERVER 1</div>
        <div id="hud-coins-live">ğŸª™ 0</div>
      </div>
      <div class="phud" style="text-align:right"><div class="pname" id="h-right">OPPONENT</div><div class="hp-wrap"><div class="hp-fill" id="hp-right" style="width:100%;float:right"></div></div></div>
      <div id="hud-lead"></div>
    </div>
    <canvas id="c" width="820" height="560"></canvas>
    <div id="go">
      <div id="ph-conn" style="display:flex;flex-direction:column;align-items:center;gap:12px;">
        <div class="spinner"></div>
        <div style="font-family:'Black Ops One',cursive;font-size:18px;letter-spacing:4px;color:var(--gold);">CONNECTING<span class="dot-anim"></span></div>
      </div>
      <div id="ph-wait" style="display:none;flex-direction:column;align-items:center;">
        <div style="font-family:'Black Ops One',cursive;font-size:22px;letter-spacing:4px;margin-bottom:6px;">WAITING FOR PLAYERS</div>
        <div id="wait-sub" style="font-size:14px;letter-spacing:3px;color:#555;margin-bottom:18px;"></div>
        <div id="plist"></div>
        <button class="btn" id="start-btn" style="display:none" onclick="reqStart()">â–¶ START GAME</button>
      </div>
    </div>
    <div id="death-screen">
      <div id="death-msg">YOU WERE DESTROYED</div>
      <div id="death-timer">Respawning in 4...</div>
    </div>
    <div id="chat"><div id="chat-log"></div><div id="chat-row"><input id="ci" placeholder="chat..." maxlength="60" onkeydown="if(event.key==='Enter')sendChat()"/><button id="cs" onclick="sendChat()">â–¶</button></div></div>
    <div id="kf"></div>
    <div id="ability-bar">
      <div class="ab-slot" id="ab1">â“<span class="ab-key">Q</span></div>
      <div class="ab-slot" id="ab2">â“<span class="ab-key">E</span></div>
    </div>
    <canvas id="minimap-canvas" width="120" height="90"></canvas>
    <div id="ctrl-tip">WASD/ARROWS â€” MOVE<br>SPACE â€” FIRE<br>Q/E â€” ABILITIES</div>
  </div>
</div>

</div><!-- #app -->
<script src="https://cdn.ably.com/lib/ably.min-2.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TANK CLASH  â€” complete rewrite with all fixes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ABLY_KEY='Xzs3kg.94NIEw:6DtlFTphDJ7SPj-HQKQfI-oVMLXHw5H1vU0JVu8VhlY';
const ROOMS=[{id:'tc-r1',name:'Server 1',flag:'ğŸ”´'},{id:'tc-r2',name:'Server 2',flag:'ğŸ”µ'},{id:'tc-r3',name:'Server 3',flag:'ğŸŸ¢'}];
const MAX_P=8;
const COLORS=['#ff4040','#40c8ff','#ffd700','#40ff80','#ff40ff','#ff9900','#00ffee','#a0ff40'];
const MAP_W=2000,MAP_H=1500,VP_W=820,VP_H=560;
const SPAWNS=[
  {x:130,y:750,a:0},{x:1870,y:750,a:Math.PI},
  {x:1000,y:130,a:Math.PI*.5},{x:1000,y:1370,a:-Math.PI*.5},
  {x:220,y:220,a:Math.PI*.25},{x:1780,y:220,a:Math.PI*.75},
  {x:220,y:1280,a:-Math.PI*.25},{x:1780,y:1280,a:-Math.PI*.75}
];
const RESPAWN_SECS=4;

// â”€â”€ TANK DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TANKS=[
  {id:'basic',  name:'GRUNT',     cost:0,    color:'#40c8ff',spd:3.2,hp:100,dmg:20,bspd:8,  shape:'rect',
   ab:[{name:'Shield',icon:'ğŸ›¡ï¸',cd:600,fn:'abilityShield'},{name:'Burst',icon:'ğŸ’¥',cd:400,fn:'abilityBurst'}]},
  {id:'heavy',  name:'HEAVY',     cost:300,  color:'#ff9900',spd:2.2,hp:160,dmg:35,bspd:6,  shape:'heavy',
   ab:[{name:'Stomp',icon:'ğŸ’¢',cd:500,fn:'abilityBurst'},{name:'Armor',icon:'ğŸ”©',cd:700,fn:'abilityShield'}]},
  {id:'speedy', name:'PHANTOM',   cost:400,  color:'#40ff80',spd:5.0,hp:70, dmg:15,bspd:12, shape:'speedy',
   ab:[{name:'Dash',icon:'âš¡',cd:300,fn:'abilityDash'},{name:'Ghost',icon:'ğŸ‘»',cd:600,fn:'abilityGhost'}]},
  {id:'sniper', name:'SNIPER',    cost:500,  color:'#ff4040',spd:2.6,hp:80, dmg:50,bspd:14, shape:'sniper',
   ab:[{name:'Scope',icon:'ğŸ”­',cd:400,fn:'abilityScope'},{name:'Shield',icon:'ğŸ›¡ï¸',cd:600,fn:'abilityShield'}]},
  {id:'bomber', name:'BOMBER',    cost:600,  color:'#ff40ff',spd:2.8,hp:90, dmg:30,bspd:7,  shape:'rect',
   ab:[{name:'Mine',icon:'ğŸ’£',cd:350,fn:'abilityMine'},{name:'Burst',icon:'ğŸ’¥',cd:500,fn:'abilityBurst'}]},
  {id:'titan',  name:'TITAN',     cost:1200, color:'#ffd700',spd:1.8,hp:220,dmg:45,bspd:5,  shape:'heavy',
   ab:[{name:'Quake',icon:'ğŸŒ‹',cd:700,fn:'abilityBurst'},{name:'Regen',icon:'ğŸ’š',cd:600,fn:'abilityRegen'}]},
];

// â”€â”€ PLAYER DATA (cloud-saved) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Key = localStorage key (acts as cloud save identifier per browser)
// We use window.storage if available (artifact cloud), else localStorage
const SAVE_KEY='tankclash_save_v2';
let saveData={coins:0,owned:['basic'],equippedTank:'basic'};

async function loadSave(){
  // Try window.storage (artifact cloud save) first
  try{
    const r=await window.storage.get(SAVE_KEY);
    if(r&&r.value){
      const loaded=JSON.parse(r.value);
      // merge to not lose defaults for new fields
      saveData={...saveData,...loaded};
      if(!saveData.owned) saveData.owned=['basic'];
      if(!saveData.equippedTank) saveData.equippedTank='basic';
    }
  }catch(e){
    // window.storage not available â€” silent fail, use defaults
  }
  updateCoinDisplays();
}

async function writeSave(){
  const json=JSON.stringify(saveData);
  try{
    await window.storage.set(SAVE_KEY,json);
  }catch(e){
    // storage not available in this context
  }
  updateCoinDisplays();
}

function updateCoinDisplays(){
  document.getElementById('coin-display').textContent='ğŸª™ '+saveData.coins;
  document.getElementById('shop-coins').textContent='ğŸª™ '+saveData.coins;
  document.getElementById('hud-coins-live').textContent='ğŸª™ '+saveData.coins;
}

function myTankDef(){return TANKS.find(t=>t.id===saveData.equippedTank)||TANKS[0];}

// â”€â”€ SHOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderShop(){
  updateCoinDisplays();
  const grid=document.getElementById('shop-grid');
  grid.innerHTML='';
  TANKS.forEach(t=>{
    const owned=saveData.owned.includes(t.id);
    const equipped=saveData.equippedTank===t.id;
    const canAfford=saveData.coins>=t.cost;
    const card=document.createElement('div');
    card.className='tank-card'+(owned?' owned':'')+(equipped?' selected':'')+((!owned&&!canAfford)?' locked':'');

    // preview canvas
    const cv=document.createElement('canvas');cv.width=80;cv.height=60;cv.className='tc-canvas';
    const cx=cv.getContext('2d');
    drawTankPreview(cx,t,40,30);

    card.innerHTML='<div class="tc-name" style="color:'+t.color+'">'+t.name+'</div>';
    card.appendChild(cv);
    card.innerHTML+='<div class="tc-stat"><span style="color:#555;width:42px">SPD</span><div class="tc-bar"><div class="tc-bar-fill" style="width:'+Math.round(t.spd/5*100)+'%;background:'+t.color+'"></div></div></div>'
      +'<div class="tc-stat"><span style="color:#555;width:42px">HP</span><div class="tc-bar"><div class="tc-bar-fill" style="width:'+Math.round(t.hp/220*100)+'%;background:'+t.color+'"></div></div></div>'
      +'<div class="tc-stat"><span style="color:#555;width:42px">DMG</span><div class="tc-bar"><div class="tc-bar-fill" style="width:'+Math.round(t.dmg/50*100)+'%;background:'+t.color+'"></div></div></div>'
      +'<div class="tc-abilities">'+t.ab.map(a=>a.icon+' '+a.name).join(' &nbsp; ')+'</div>';
    if(equipped){
      card.innerHTML+='<div class="tc-badge badge-sel">EQUIPPED</div>';
    } else if(owned){
      card.innerHTML+='<div class="tc-badge badge-owned">OWNED</div>';
      card.innerHTML+='<button class="btn btn-sm" style="margin-top:8px;width:100%" onclick="equipTank(\''+t.id+'\')">EQUIP</button>';
    } else {
      card.innerHTML+='<div class="tc-price">ğŸª™ '+t.cost+'</div>';
      card.innerHTML+='<button class="btn btn-sm" style="margin-top:6px;width:100%;'+(canAfford?'':'opacity:.35;cursor:not-allowed')+'" '+(canAfford?'onclick="buyTank(\''+t.id+'\')"':'disabled')+'>BUY</button>';
    }
    grid.appendChild(card);
  });
}

function drawTankPreview(cx,t,px,py){
  cx.save();cx.translate(px,py);
  cx.shadowColor=t.color;cx.shadowBlur=16;cx.fillStyle=t.color;
  if(t.shape==='heavy'){cx.beginPath();cx.roundRect(-18,-14,36,28,3);cx.fill();}
  else if(t.shape==='speedy'){cx.beginPath();cx.moveTo(20,0);cx.lineTo(-14,-10);cx.lineTo(-10,0);cx.lineTo(-14,10);cx.closePath();cx.fill();}
  else if(t.shape==='sniper'){cx.beginPath();cx.roundRect(-12,-9,24,18,3);cx.fill();}
  else{cx.beginPath();cx.roundRect(-15,-12,30,24,4);cx.fill();}
  cx.shadowBlur=0;cx.fillStyle='rgba(0,0,0,0.3)';
  if(t.shape==='heavy') cx.fillRect(6,-3.5,24,7);
  else if(t.shape==='sniper'){cx.fillRect(10,-2,26,4);cx.fillRect(34,-3,5,6);}
  else cx.fillRect(7,-3,20,6);
  cx.restore();
}

function buyTank(id){
  const t=TANKS.find(x=>x.id===id);
  if(!t||saveData.owned.includes(id)||saveData.coins<t.cost) return;
  saveData.coins-=t.cost;
  saveData.owned.push(id);
  writeSave();
  renderShop();
}
function equipTank(id){
  if(!saveData.owned.includes(id)) return;
  saveData.equippedTank=id;
  writeSave();
  renderShop();
}

// â”€â”€ ABILITY SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let abCooldowns=[0,0];
const ABILITY_EFFECTS={
  abilityShield:()=>{ if(!myTank||!myTank.alive) return; myTank.invulnTimer=Math.max(myTank.invulnTimer,180); addKF('ğŸ›¡ï¸','SHIELD ON'); },
  abilityBurst:()=>{
    if(!myTank||!myTank.alive) return;
    for(let i=0;i<8;i++){
      const a=(Math.PI*2/8)*i;
      const bid=myId+'_ab'+(bulletSeq++);
      const bx=myTank.x+Math.cos(a)*20,by=myTank.y+Math.sin(a)*20;
      bullets.push({id:bid,x:bx,y:by,vx:Math.cos(a)*B_SPD*1.2,vy:Math.sin(a)*B_SPD*1.2,owner:myId,color:myTank.color,bounces:0,dmg:myTankDef().dmg});
      channel.publish('evt',{e:'shoot',from:myId,bid,bx,by,angle:a});
    }
    addKF('ğŸ’¥','BURST!');
  },
  abilityDash:()=>{
    if(!myTank||!myTank.alive) return;
    myTank.vx=Math.cos(myTank.angle)*18;myTank.vy=Math.sin(myTank.angle)*18;
    spawnPart(myTank.x,myTank.y,myTank.color,12,5);addKF('âš¡','DASH!');
  },
  abilityGhost:()=>{
    if(!myTank||!myTank.alive) return;
    myTank.ghost=(myTank.ghost||0)+180;addKF('ğŸ‘»','GHOST!');
  },
  abilityScope:()=>{ addKF('ğŸ”­','SCOPE'); },
  abilityMine:()=>{
    if(!myTank||!myTank.alive) return;
    const mx=myTank.x-Math.cos(myTank.angle)*30,my2=myTank.y-Math.sin(myTank.angle)*30;
    mines.push({x:mx,y:my2,owner:myId,color:myTank.color,armed:0});
    addKF('ğŸ’£','MINE PLACED');
  },
  abilityRegen:()=>{
    if(!myTank||!myTank.alive) return;
    myTank.hp=Math.min(myTankDef().hp,myTank.hp+40);updateHUD();addKF('ğŸ’š','REGEN +40');
  },
};
function useAbility(slot){
  if(!gameActive||!myTank||!myTank.alive) return;
  if(abCooldowns[slot]>0) return;
  const def=myTankDef();
  const ab=def.ab[slot];
  if(!ab) return;
  const fn=ABILITY_EFFECTS[ab.fn];
  if(fn) fn();
  abCooldowns[slot]=ab.cd;
}
function updateAbilityBar(){
  const def=myTankDef();
  [0,1].forEach(i=>{
    const slot=document.getElementById('ab'+(i+1));
    const ab=def.ab[i];
    if(!ab){slot.innerHTML=(i===0?'â“':'â“')+'<span class="ab-key">'+(i===0?'Q':'E')+'</span>';return;}
    const cd=abCooldowns[i];
    const cdFrac=cd/ab.cd;
    slot.innerHTML=ab.icon+'<span class="ab-key">'+(i===0?'Q':'E')+'</span>';
    if(cd>0) slot.innerHTML+=`<div class="ab-cd">${Math.ceil(cd/60)}s</div>`;
    slot.style.borderColor=cd>0?'rgba(255,255,255,0.05)':'rgba(255,215,0,0.4)';
  });
}

// â”€â”€ NETWORKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let myId='p'+Math.random().toString(36).slice(2,9);
let myNick='Player',myColor=COLORS[0],myRoom=null;
let ably=null,channel=null,connected=false;
let players={},myTank=null,gameActive=false;
let svCounts={};

// â”€â”€ GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let camX=MAP_W/2-VP_W/2,camY=MAP_H/2-VP_H/2;
let bullets=[],particles=[],shockwaves=[],walls=[],coins=[],mines=[];
let roundTimer=0,shakeFrames=0,shootTimer=0,bulletSeq=0;
let deathCountdown=0;
const keys={};

// â”€â”€ TANK STATS from def â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let T_SPD=3.2,B_SPD=8,F_CD=28,MY_HP=100,MY_DMG=20;
function applyTankStats(){
  const d=myTankDef();
  T_SPD=d.spd;B_SPD=d.bspd;F_CD=Math.round(60/d.bspd*3);MY_HP=d.hp;MY_DMG=d.dmg;
}

// â”€â”€ COLOR PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('colors').innerHTML='';
COLORS.forEach((c,i)=>{
  const d=document.createElement('div');
  d.className='cdot'+(i===0?' on':'');
  d.style.cssText='background:'+c+';box-shadow:0 0 8px '+c+'55';
  d.onclick=()=>{document.querySelectorAll('.cdot').forEach(x=>x.classList.remove('on'));d.classList.add('on');myColor=c;};
  document.getElementById('colors').appendChild(d);
});

// â”€â”€ SERVER CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderServers(){
  const grid=document.getElementById('svgrid');grid.innerHTML='';
  ROOMS.forEach(r=>{
    const cnt=svCounts[r.id]||0,full=cnt>=MAX_P,pct=(cnt/MAX_P)*100;
    const bc=pct<50?'#40ff80':pct<80?'#ffd700':'#ff4040';
    const d=document.createElement('div');
    d.className='sv'+(full?' full':'')+(myRoom===r.id?' on':'');
    d.innerHTML='<div class="sv-flag">'+r.flag+'</div><div class="sv-name">'+r.name+'</div>'
      +'<div class="sv-cnt" style="color:'+bc+'">'+cnt+'<span style="color:#333;font-size:13px"> / '+MAX_P+'</span></div>'
      +'<div class="sv-bar"><div class="sv-fill" style="width:'+pct+'%;background:'+bc+'"></div></div>'
      +'<div class="sv-tick">âœ“ SELECTED</div>';
    if(!full) d.onclick=()=>{myRoom=r.id;renderServers();refreshBtn();};
    grid.appendChild(d);
  });
}
renderServers();

function refreshBtn(){
  const ok=connected&&!!myRoom;
  const btn=document.getElementById('join-btn');
  btn.disabled=!ok;
  btn.textContent=!connected?'âš” JOIN BATTLE':(!myRoom?'SELECT A SERVER':'âš” JOIN BATTLE');
}
function stat(m,c){const e=document.getElementById('lstat');e.textContent=m;e.className=c||'';}

// â”€â”€ AUTO-CONNECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load',async()=>{
  await loadSave();
  stat('Connecting...','wait');
  ably=new Ably.Realtime({key:ABLY_KEY,clientId:myId});
  ably.connection.on('connected',()=>{
    connected=true;
    stat('Connected! Pick a server and join.','ok');
    refreshBtn();
    ROOMS.forEach(r=>{
      const ch=ably.channels.get(r.id);
      const refresh=()=>ch.presence.get().then(m=>{svCounts[r.id]=m.length;renderServers();}).catch(()=>{});
      ch.attach().then(()=>{ch.presence.subscribe(refresh);refresh();}).catch(()=>{});
    });
  });
  ably.connection.on('failed',()=>{connected=false;stat('Connection failed','err');refreshBtn();});
  ably.connection.on('disconnected',()=>{connected=false;stat('Disconnectedâ€”reconnecting...','err');refreshBtn();});
  ably.connection.on('suspended',()=>{connected=false;stat('Suspendedâ€”refresh','err');refreshBtn();});
});

document.getElementById('nick').oninput=()=>{
  myNick=document.getElementById('nick').value.trim()||'Player';
  document.getElementById('nick-err').textContent='';
};

// â”€â”€ JOIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doJoin(){
  myNick=document.getElementById('nick').value.trim()||'Player';
  channel=ably.channels.get(myRoom);
  channel.presence.get()
    .then(members=>{
      const taken=members.some(m=>m.data&&m.data.nick&&m.data.nick.toLowerCase()===myNick.toLowerCase());
      if(taken){document.getElementById('nick-err').textContent='Name taken in this server!';return;}
      actuallyJoin();
    })
    .catch(()=>actuallyJoin());
}

function actuallyJoin(){
  document.getElementById('join-btn').disabled=true;
  applyTankStats();
  channel.subscribe('mv',onMove);
  channel.subscribe('evt',onEvt);
  channel.subscribe('chat',onChatMsg);

  channel.presence.subscribe(msg=>{
    if(msg.clientId===myId) return;
    if(msg.action==='enter'||msg.action==='present') regPlayer(msg.clientId,msg.data.nick,msg.data.color,msg.data.tankId);
    if(msg.action==='leave') delete players[msg.clientId];
    if(!gameActive) refreshLobbyOverlay();
  });

  const td=myTankDef();
  channel.presence.enter({nick:myNick,color:myColor,tankId:td.id})
    .then(()=>{
      showScreen('game-screen');
      document.getElementById('hud-room').textContent='SERVER '+(ROOMS.findIndex(r=>r.id===myRoom)+1);
      buildWalls();showPhase('conn');
      return channel.presence.get();
    })
    .then(members=>{
      members.forEach(m=>{if(m.clientId!==myId) regPlayer(m.clientId,m.data.nick,m.data.color,m.data.tankId);});
      showPhase('wait');refreshLobbyOverlay();
    })
    .catch(err=>{stat('Join failed: '+(err.message||err),'err');document.getElementById('join-btn').disabled=false;});
}

function regPlayer(id,nick,color,tankId){
  const td=TANKS.find(t=>t.id===tankId)||TANKS[0];
  if(players[id]){players[id].nick=nick;players[id].color=color;players[id].tankDef=td;return;}
  players[id]={id,nick,color,tankDef:td,hp:td.hp,alive:true,kills:0,x:1000,y:750,angle:0,vx:0,vy:0,trail:[],invulnTimer:0,ghost:0};
}

// â”€â”€ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPhase(p){
  document.getElementById('ph-conn').style.display=p==='conn'?'flex':'none';
  document.getElementById('ph-wait').style.display=p==='wait'?'flex':'none';
  document.getElementById('go').classList.remove('hide');
}
function hideOverlay(){document.getElementById('go').classList.add('hide');}

function refreshLobbyOverlay(){
  const all=allPlayers(),cnt=all.length;
  document.getElementById('wait-sub').textContent=cnt+' player'+(cnt!==1?'s':'')+' in room'+(cnt<2?' â€” need 2':'');
  document.getElementById('start-btn').style.display=cnt>=2?'block':'none';
  const list=document.getElementById('plist');list.innerHTML='';
  all.forEach(p=>{
    const d=document.createElement('div');d.className='pr';
    d.innerHTML='<div class="pr-dot" style="background:'+p.color+';box-shadow:0 0 5px '+p.color+'44"></div>'
      +'<div class="pr-nick" style="color:'+p.color+'">'+p.nick+'</div>'
      +'<div class="pr-you">'+(p.id===myId?'(YOU)':'')+'</div>'
      +'<div class="pr-sc">'+(p.kills||0)+' kills</div>';
    list.appendChild(d);
  });
}

function allPlayers(){
  const me={id:myId,nick:myNick,color:myColor,kills:players[myId]?.kills||0};
  return [me,...Object.values(players).filter(p=>p.id!==myId)];
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastNonce='';
function reqStart(){
  const ids=[myId,...Object.keys(players)];
  const spawnMap={};
  ids.forEach((id,i)=>{spawnMap[id]=SPAWNS[i%SPAWNS.length];});
  channel.publish('evt',{e:'start',spawnMap,nonce:Math.random().toString(36).slice(2)});
}

function doStart(spawnMap,nonce){
  if(nonce&&nonce===lastNonce) return;
  if(nonce) lastNonce=nonce;
  bullets=[];particles=[];shockwaves=[];coins=[];mines=[];
  roundTimer=0;shootTimer=0;gameActive=true;deathCountdown=0;abCooldowns=[0,0];
  document.getElementById('death-screen').style.display='none';
  applyTankStats();

  const sp=spawnMap[myId]||SPAWNS[0];
  myTank={id:myId,nick:myNick,color:myColor,tankDef:myTankDef(),
          x:sp.x,y:sp.y,angle:sp.a,hp:MY_HP,alive:true,
          kills:players[myId]?.kills||0,
          vx:0,vy:0,trail:[],invulnTimer:0,ghost:0};
  players[myId]=myTank;

  Object.keys(spawnMap).forEach(id=>{
    if(id===myId) return;
    const s=spawnMap[id];
    const p=players[id];
    if(p) Object.assign(p,{x:s.x,y:s.y,angle:s.a,hp:p.tankDef?.hp||100,alive:true,vx:0,vy:0,trail:[],invulnTimer:0,ghost:0});
  });

  camX=sp.x-VP_W/2;camY=sp.y-VP_H/2;clampCam();
  hideOverlay();updateHUD();
}

// â”€â”€ RESPAWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getRandomSpawn(){
  let best=SPAWNS[0],bestDist=0;
  SPAWNS.forEach(sp=>{
    let minD=Infinity;
    Object.values(players).forEach(p=>{if(p.alive&&p.id!==myId) minD=Math.min(minD,Math.hypot(p.x-sp.x,p.y-sp.y));});
    if(minD>bestDist){bestDist=minD;best=sp;}
  });
  return best;
}
function respawnMe(){
  const sp=getRandomSpawn();
  Object.assign(myTank,{x:sp.x,y:sp.y,angle:sp.a,hp:MY_HP,alive:true,vx:0,vy:0,trail:[],invulnTimer:180,ghost:0});
  camX=sp.x-VP_W/2;camY=sp.y-VP_H/2;clampCam();
  document.getElementById('death-screen').style.display='none';
  channel.publish('evt',{e:'respawn',id:myId,x:sp.x,y:sp.y,a:sp.a});
  updateHUD();
}

// â”€â”€ REMOTE MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onMove(msg){
  const d=msg.data;if(d.id===myId) return;
  const p=players[d.id];if(!p) return;
  p.x=lerp(p.x,d.x,0.35);p.y=lerp(p.y,d.y,0.35);p.angle=lerpAngle(p.angle,d.angle,0.35);
}

function onEvt(msg){
  const d=msg.data;
  if(d.e==='start') doStart(d.spawnMap,d.nonce);

  if(d.e==='shoot'&&d.from!==myId){
    const p=players[d.from];if(!p) return;
    const dmg=(p.tankDef?.dmg)||20;
    bullets.push({id:d.bid,x:d.bx,y:d.by,vx:Math.cos(d.angle)*((p.tankDef?.bspd)||8),vy:Math.sin(d.angle)*((p.tankDef?.bspd)||8),owner:d.from,color:p.color,bounces:0,dmg});
  }

  if(d.e==='hit'){
    // FIX DOUBLE KILLS: only the VICTIM processes their own HP.
    // Everyone else just does visuals (particles/shockwave).
    // The 'kill' and coin drop only happen once â€” on the killer's client when they detect hp<=0.
    const v=players[d.victim];if(!v) return;
    bullets=bullets.filter(b=>b.id!==d.bid);
    spawnPart(d.bx,d.by,v.color,14,4);spawnWave(d.bx,d.by,v.color);shakeFrames=6;
    // Only update HP if we're not the victim (victim's HP is authoritative on their own client)
    if(d.victim!==myId){
      v.hp=d.hp;
      if(d.hp<=0){
        v.alive=false;v.invulnTimer=0;
        spawnPart(v.x,v.y,v.color,40,8);spawnWave(v.x,v.y,v.color);shakeFrames=12;
        addKF(d.knick,d.vnick);
        // Kills/coins are handled ONLY in the bullet loop on killer's client â€” NOT here
        // to avoid double counting. We only do visuals here.
      } else {
        if(v.invulnTimer===0) v.invulnTimer=80;
      }
    }
    updateHUD();
  }

  if(d.e==='respawn'){
    const p=players[d.id];if(!p) return;
    Object.assign(p,{x:d.x,y:d.y,angle:d.a,hp:p.tankDef?.hp||100,alive:true,vx:0,vy:0,trail:[],invulnTimer:180,ghost:0});
    updateHUD();
  }

  if(d.e==='coin_collect') coins=coins.filter(c=>c.id!==d.cid);
}

function onChatMsg(msg){addChatLine(msg.data.nick,msg.data.msg,msg.data.color);}

// â”€â”€ COINS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let coinSeq=0;
function spawnCoins(x,y,color,n){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,r=20+Math.random()*40;
    coins.push({id:myId+'_c'+(coinSeq++),x:x+Math.cos(a)*r,y:y+Math.sin(a)*r,color,life:1,age:0,vx:Math.cos(a)*2,vy:Math.sin(a)*2});
  }
}
function updateCoins(){
  coins.forEach(c=>{c.x+=c.vx;c.y+=c.vy;c.vx*=0.88;c.vy*=0.88;c.age++;});
  if(myTank&&myTank.alive){
    coins=coins.filter(c=>{
      if(c.age<20) return true;
      if(Math.hypot(c.x-myTank.x,c.y-myTank.y)<22){
        saveData.coins++;writeSave();
        spawnPart(c.x,c.y,'#ffd700',6,3);
        channel.publish('evt',{e:'coin_collect',cid:c.id});
        return false;
      }
      return true;
    });
  }
  coins=coins.filter(c=>c.age<1200);
}

// â”€â”€ PHYSICS HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX: WASD + Arrow keys both supported
document.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault();
  if(e.code==='KeyQ') useAbility(0);
  if(e.code==='KeyE') useAbility(1);
  if(e.code==='Enter'&&gameActive){const ci=document.getElementById('ci');if(document.activeElement!==ci) ci.focus();}
});
document.addEventListener('keyup',e=>keys[e.code]=false);

function lerp(a,b,t){return a+(b-a)*t;}
function lerpAngle(a,b,t){let d=b-a;while(d>Math.PI)d-=Math.PI*2;while(d<-Math.PI)d+=Math.PI*2;return a+d*t;}
function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){return ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by;}
function tankInWall(t){for(const w of walls)if(rectsOverlap(t.x-15,t.y-13,30,26,w.x,w.y,w.w,w.h))return w;return null;}
function bulletHitsWall(b){for(const w of walls)if(b.x>w.x&&b.x<w.x+w.w&&b.y>w.y&&b.y<w.y+w.h)return w;return null;}
function clampCam(){camX=Math.max(0,Math.min(MAP_W-VP_W,camX));camY=Math.max(0,Math.min(MAP_H-VP_H,camY));}

function buildWalls(){
  const T=16;
  walls=[
    {x:0,y:0,w:MAP_W,h:T},{x:0,y:MAP_H-T,w:MAP_W,h:T},{x:0,y:0,w:T,h:MAP_H},{x:MAP_W-T,y:0,w:T,h:MAP_H},
    {x:300,y:280,w:220,h:32},{x:300,y:1188,w:220,h:32},{x:180,y:500,w:32,h:220},{x:180,y:780,w:32,h:220},{x:440,y:620,w:180,h:32},
    {x:1480,y:280,w:220,h:32},{x:1480,y:1188,w:220,h:32},{x:1788,y:500,w:32,h:220},{x:1788,y:780,w:32,h:220},{x:1380,y:620,w:180,h:32},
    {x:860,y:200,w:32,h:220},{x:1108,y:200,w:32,h:220},{x:700,y:380,w:220,h:32},{x:1080,y:380,w:220,h:32},
    {x:860,y:1080,w:32,h:220},{x:1108,y:1080,w:32,h:220},{x:700,y:1088,w:220,h:32},{x:1080,y:1088,w:220,h:32},
    {x:700,y:580,w:260,h:32},{x:1040,y:580,w:260,h:32},{x:700,y:888,w:260,h:32},{x:1040,y:888,w:260,h:32},
    {x:920,y:500,w:160,h:32},{x:920,y:968,w:160,h:32},{x:960,y:620,w:32,h:260},
    {x:580,y:700,w:32,h:200},{x:1388,y:700,w:32,h:200},
  ];
}

function spawnPart(x,y,color,n,sp){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=Math.random()*sp+1;particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:Math.random()*.03+.015,r:Math.random()*3+1,color});}}
function spawnWave(x,y,color){shockwaves.push({x,y,r:4,maxR:70,life:1,color});}

let lastSendTime=0;
function trySendMove(){
  if(!channel||!myTank) return;
  const now=Date.now();if(now-lastSendTime<50) return;lastSendTime=now;
  channel.publish('mv',{id:myId,x:Math.round(myTank.x*10)/10,y:Math.round(myTank.y*10)/10,angle:Math.round(myTank.angle*100)/100});
}
function tryShoot(){
  if(!myTank||!myTank.alive||shootTimer>0) return;
  shootTimer=F_CD;
  const bid=myId+'_'+(bulletSeq++);
  const bx=myTank.x+Math.cos(myTank.angle)*22,by=myTank.y+Math.sin(myTank.angle)*22;
  bullets.push({id:bid,x:bx,y:by,vx:Math.cos(myTank.angle)*B_SPD,vy:Math.sin(myTank.angle)*B_SPD,owner:myId,color:myTank.color,bounces:0,dmg:MY_DMG});
  myTank.vx-=Math.cos(myTank.angle)*1.2;myTank.vy-=Math.sin(myTank.angle)*1.2;
  channel.publish('evt',{e:'shoot',from:myId,bid,bx,by,angle:myTank.angle});
}

// â”€â”€ UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function update(){
  // tick invuln + ghost always
  Object.values(players).forEach(p=>{
    if(p.invulnTimer>0) p.invulnTimer--;
    if(p.ghost>0) p.ghost--;
  });
  // tick ability cooldowns
  abCooldowns=[Math.max(0,abCooldowns[0]-1),Math.max(0,abCooldowns[1]-1)];

  // death countdown
  if(deathCountdown>0){
    deathCountdown--;
    const secs=Math.ceil(deathCountdown/60);
    document.getElementById('death-timer').textContent='Respawning in '+secs+'...';
    if(deathCountdown===0) respawnMe();
  }

  if(!gameActive) return;
  roundTimer++;if(shootTimer>0) shootTimer--;

  if(myTank&&myTank.alive){
    // WASD + Arrow keys both work
    const turnLeft= keys['ArrowLeft'] ||keys['KeyA'];
    const turnRight=keys['ArrowRight']||keys['KeyD'];
    const fwd=      keys['ArrowUp']   ||keys['KeyW'];
    const bwd=      keys['ArrowDown'] ||keys['KeyS'];
    if(turnLeft)  myTank.angle-=0.046;
    if(turnRight) myTank.angle+=0.046;
    if(fwd) {myTank.vx+=Math.cos(myTank.angle)*.55;myTank.vy+=Math.sin(myTank.angle)*.55;}
    if(bwd) {myTank.vx-=Math.cos(myTank.angle)*.3; myTank.vy-=Math.sin(myTank.angle)*.3;}
    if(keys['Space']) tryShoot();
    myTank.vx*=.83;myTank.vy*=.83;
    const spd=Math.hypot(myTank.vx,myTank.vy);
    if(spd>T_SPD){myTank.vx=myTank.vx/spd*T_SPD;myTank.vy=myTank.vy/spd*T_SPD;}
    const px=myTank.x,py=myTank.y;
    myTank.x+=myTank.vx;if(tankInWall(myTank)){myTank.x=px;myTank.vx*=-.3;}
    myTank.y+=myTank.vy;if(tankInWall(myTank)){myTank.y=py;myTank.vy*=-.3;}
    myTank.trail=myTank.trail||[];myTank.trail.unshift({x:myTank.x,y:myTank.y});if(myTank.trail.length>16) myTank.trail.pop();
    trySendMove();
    camX=lerp(camX,myTank.x-VP_W/2,0.1);camY=lerp(camY,myTank.y-VP_H/2,0.1);clampCam();
  }

  // mines
  for(let i=mines.length-1;i>=0;i--){
    const m=mines[i];m.armed++;
    if(m.armed<90) continue;
    let triggered=false;
    for(const pid in players){
      if(pid===m.owner) continue;
      const t=players[pid];if(!t.alive) continue;
      if(Math.hypot(t.x-m.x,t.y-m.y)<30){
        spawnPart(m.x,m.y,'#ff9900',30,8);spawnWave(m.x,m.y,'#ff9900');shakeFrames=10;
        if(m.owner===myId){
          const newHp=Math.max(0,(t.hp||100)-40);t.hp=newHp;
          channel.publish('evt',{e:'hit',from:myId,victim:pid,killer:myId,bid:'mine_'+i,bx:m.x,by:m.y,hp:newHp,knick:myNick,vnick:t.nick});
          if(newHp<=0){t.alive=false;t.invulnTimer=0;spawnPart(t.x,t.y,t.color,40,8);myTank.kills=(myTank.kills||0)+1;spawnCoins(t.x,t.y,t.color,5);}
        }
        triggered=true;break;
      }
    }
    if(triggered){mines.splice(i,1);}
  }

  // bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];b.x+=b.vx;b.y+=b.vy;
    const hw=bulletHitsWall(b);
    if(hw){
      if(b.bounces>=2){spawnPart(b.x,b.y,b.color,5,2);bullets.splice(i,1);continue;}
      b.bounces++;
      const dx=(b.x-(hw.x+hw.w/2))/hw.w,dy=(b.y-(hw.y+hw.h/2))/hw.h;
      if(Math.abs(dx)>Math.abs(dy))b.vx*=-1;else b.vy*=-1;
      spawnPart(b.x,b.y,b.color,4,2);continue;
    }
    if(b.owner===myId){
      let hit=false;
      for(const pid in players){
        if(pid===myId) continue;
        const t=players[pid];
        if(!t.alive||t.invulnTimer>0||t.ghost>0) continue;
        if(Math.hypot(b.x-t.x,b.y-t.y)<18){
          const dmg=b.dmg||MY_DMG;
          const newHp=Math.max(0,(t.hp||100)-dmg);
          t.hp=newHp;if(newHp>0) t.invulnTimer=80;
          channel.publish('evt',{e:'hit',from:myId,victim:pid,killer:myId,bid:b.id,bx:b.x,by:b.y,hp:newHp,knick:myNick,vnick:t.nick});
          spawnPart(b.x,b.y,t.color,14,4);spawnWave(b.x,b.y,t.color);shakeFrames=6;
          if(newHp<=0){
            t.alive=false;t.invulnTimer=0;
            spawnPart(t.x,t.y,t.color,40,8);spawnWave(t.x,t.y,t.color);shakeFrames=12;
            addKF(myNick,t.nick);
            // FIX DOUBLE KILLS: only increment here (killer's client), NOT in onEvt('hit')
            myTank.kills=(myTank.kills||0)+1;
            players[myId]=myTank;
            spawnCoins(t.x,t.y,t.color,5);
            updateHUD();
          }
          bullets.splice(i,1);hit=true;break;
        }
      }
      if(hit) continue;
    }
    if(b.x<-50||b.x>MAP_W+50||b.y<-50||b.y>MAP_H+50) bullets.splice(i,1);
  }

  // detect MY death from remote hit
  if(myTank&&!myTank.alive&&deathCountdown===0){
    deathCountdown=RESPAWN_SECS*60;
    document.getElementById('death-screen').style.display='flex';
    document.getElementById('death-timer').textContent='Respawning in '+RESPAWN_SECS+'...';
  }

  updateCoins();
  updateAbilityBar();
  for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vx*=.91;p.vy*=.91;p.life-=p.decay;if(p.life<=0)particles.splice(i,1);}
  for(let i=shockwaves.length-1;i>=0;i--){const s=shockwaves[i];s.r+=(s.maxR-s.r)*.18;s.life-=.055;if(s.life<=0)shockwaves.splice(i,1);}
}

// â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHUD(){
  const me=players[myId]||myTank;
  const opp=Object.values(players).find(p=>p.id!==myId);
  const maxHp=myTankDef().hp;
  if(me){
    document.getElementById('h-left').textContent='â–¶ '+me.nick;
    document.getElementById('h-left').style.color=me.color;
    document.getElementById('hp-left').style.cssText='width:'+Math.max(0,(me.hp||0)/maxHp*100)+'%;background:'+me.color+';box-shadow:0 0 6px '+me.color;
  }
  if(opp){
    const oppMaxHp=opp.tankDef?.hp||100;
    document.getElementById('h-right').textContent=opp.nick+' â—€';
    document.getElementById('h-right').style.color=opp.color;
    document.getElementById('hp-right').style.cssText='width:'+Math.max(0,(opp.hp||0)/oppMaxHp*100)+'%;background:'+opp.color+';box-shadow:0 0 6px '+opp.color+';float:right';
  }
  const sorted=Object.values(players).sort((a,b)=>(b.kills||0)-(a.kills||0));
  document.getElementById('hud-score').textContent=sorted.slice(0,3).map(p=>(p.kills||0)+'K '+p.nick).join(' Â· ');
  const lead=document.getElementById('hud-lead');lead.innerHTML='';
  sorted.slice(0,4).forEach((p,i)=>{
    const r=document.createElement('div');r.className='lead-row';
    r.innerHTML=(i===0&&(p.kills||0)>0?'ğŸ‘‘':'  ')
      +'<div class="lead-dot" style="background:'+p.color+'"></div>'
      +'<span class="lead-name" style="color:'+p.color+'">'+p.nick+'</span>'
      +'<span class="lead-kills">'+(p.kills||0)+'K</span>';
    lead.appendChild(r);
  });
  updateCoinDisplays();
}

// â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addChatLine(nick,msg,color){
  const log=document.getElementById('chat-log');
  const d=document.createElement('div');d.className='cm';
  d.innerHTML='<span style="color:'+(color||'#888')+'">'+nick+':</span> '+msg;
  log.appendChild(d);log.scrollTop=log.scrollHeight;
  while(log.children.length>16) log.removeChild(log.firstChild);
}
function sendChat(){
  const ci=document.getElementById('ci'),msg=ci.value.trim();
  if(!msg||!channel) return;
  channel.publish('chat',{nick:myNick,msg,color:myColor});
  addChatLine('YOU',msg,myColor);ci.value='';
}
function addKF(k,v){
  const kf=document.getElementById('kf');
  const d=document.createElement('div');d.className='kfe';
  d.textContent=k+' âš¡ '+v;kf.appendChild(d);setTimeout(()=>d.remove(),4000);
}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

// â”€â”€ DRAW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const mm=document.getElementById('minimap-canvas');
const mctx=mm.getContext('2d');

function draw(){
  ctx.save();
  if(shakeFrames>0){ctx.translate((Math.random()-.5)*shakeFrames*.8,(Math.random()-.5)*shakeFrames*.8);shakeFrames--;}
  ctx.translate(-Math.round(camX),-Math.round(camY));
  ctx.fillStyle='#0c0c18';ctx.fillRect(camX,camY,VP_W,VP_H);

  // hex grid (visible only)
  ctx.save();ctx.globalAlpha=.02;ctx.strokeStyle='#fff';ctx.lineWidth=.5;
  const hs=40,r0=Math.floor(camY/(hs*1.5))-1,r1=r0+Math.ceil(VP_H/(hs*1.5))+3;
  const c0=Math.floor(camX/(hs*1.73))-1,c1=c0+Math.ceil(VP_W/(hs*1.73))+3;
  for(let row=r0;row<r1;row++) for(let col=c0;col<c1;col++){
    const cx2=col*hs*1.73+(row%2)*hs*.865,cy2=row*hs*1.5;
    ctx.beginPath();for(let k=0;k<6;k++){const a=(Math.PI/3)*k-Math.PI/6;k===0?ctx.moveTo(cx2+hs*Math.cos(a),cy2+hs*Math.sin(a)):ctx.lineTo(cx2+hs*Math.cos(a),cy2+hs*Math.sin(a));}ctx.closePath();ctx.stroke();
  }ctx.restore();

  // walls
  for(const w of walls){
    if(w.x+w.w<camX||w.x>camX+VP_W||w.y+w.h<camY||w.y>camY+VP_H) continue;
    const g=ctx.createLinearGradient(w.x,w.y,w.x,w.y+w.h);g.addColorStop(0,'#252538');g.addColorStop(1,'#111120');
    ctx.fillStyle=g;ctx.fillRect(w.x,w.y,w.w,w.h);ctx.strokeStyle='rgba(255,255,255,0.07)';ctx.lineWidth=1;ctx.strokeRect(w.x+.5,w.y+.5,w.w-1,w.h-1);
  }

  // mines
  mines.forEach(m=>{
    const blink=m.armed>60&&Math.floor(m.armed/10)%2===0;
    ctx.save();ctx.globalAlpha=blink?.3:1;ctx.shadowColor='#ff9900';ctx.shadowBlur=12;
    ctx.fillStyle='#ff9900';ctx.beginPath();ctx.arc(m.x,m.y,7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(m.x,m.y,3,0,Math.PI*2);ctx.fill();ctx.restore();
  });

  // coins
  coins.forEach(c=>{
    const pulse=Math.sin(c.age*.12)*.3+.7;
    ctx.save();ctx.globalAlpha=pulse;ctx.shadowColor='#ffd700';ctx.shadowBlur=12;
    ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(c.x,c.y,7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,255,200,0.5)';ctx.beginPath();ctx.arc(c.x-1.5,c.y-1.5,3,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });

  for(const s of shockwaves){ctx.save();ctx.globalAlpha=s.life*.65;ctx.strokeStyle=s.color;ctx.shadowColor=s.color;ctx.shadowBlur=14;ctx.lineWidth=2.5;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=s.life*.1;ctx.fillStyle=s.color;ctx.fill();ctx.restore();}
  for(const p of particles){ctx.save();ctx.globalAlpha=p.life;ctx.shadowColor=p.color;ctx.shadowBlur=9;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);ctx.fill();ctx.restore();}
  for(const b of bullets){
    ctx.save();const g=ctx.createLinearGradient(b.x-b.vx*6,b.y-b.vy*6,b.x,b.y);g.addColorStop(0,'transparent');g.addColorStop(1,b.color+'bb');
    ctx.strokeStyle=g;ctx.lineWidth=2.5;ctx.beginPath();ctx.moveTo(b.x-b.vx*6,b.y-b.vy*6);ctx.lineTo(b.x,b.y);ctx.stroke();
    ctx.shadowColor=b.color;ctx.shadowBlur=14;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(b.x,b.y,4.5,0,Math.PI*2);ctx.fill();ctx.fillStyle=b.color;ctx.beginPath();ctx.arc(b.x,b.y,3,0,Math.PI*2);ctx.fill();ctx.restore();
  }
  for(const id in players){const t=players[id];if(t.alive) drawTank(t,id===myId);}
  ctx.restore();
  drawMinimap();
}

function drawTank(t,isMe){
  // ghost effect
  const isGhost=t.ghost>0;
  const trail=t.trail||[];
  ctx.save();
  for(let i=trail.length-1;i>=0;i--){
    const a=(1-i/trail.length)*(isGhost?.04:.12);
    ctx.beginPath();ctx.arc(trail[i].x,trail[i].y,10*(1-i/trail.length),0,Math.PI*2);
    ctx.fillStyle=t.color+Math.floor(a*255).toString(16).padStart(2,'0');ctx.fill();
  }
  const blink=t.invulnTimer>0&&Math.floor(t.invulnTimer/6)%2===1;
  if(blink&&!isMe){ctx.restore();return;}

  const shape=t.tankDef?.shape||'rect';
  ctx.save();
  if(isGhost) ctx.globalAlpha=0.35;
  ctx.translate(t.x,t.y);ctx.rotate(t.angle);
  ctx.shadowColor=t.color;ctx.shadowBlur=20;ctx.fillStyle=t.color;
  // body shape
  if(shape==='heavy'){ctx.beginPath();ctx.roundRect(-18,-14,36,28,3);ctx.fill();}
  else if(shape==='speedy'){ctx.beginPath();ctx.moveTo(22,0);ctx.lineTo(-14,-11);ctx.lineTo(-10,0);ctx.lineTo(-14,11);ctx.closePath();ctx.fill();}
  else if(shape==='sniper'){ctx.beginPath();ctx.roundRect(-12,-9,24,18,3);ctx.fill();}
  else{ctx.beginPath();ctx.roundRect(-15,-12,30,24,4);ctx.fill();}
  ctx.shadowBlur=0;ctx.fillStyle='rgba(0,0,0,0.32)';
  if(shape==='heavy'){ctx.beginPath();ctx.roundRect(-18,-14,36,28,3);ctx.fill();}
  else if(shape==='speedy'){ctx.beginPath();ctx.moveTo(22,0);ctx.lineTo(-14,-11);ctx.lineTo(-10,0);ctx.lineTo(-14,11);ctx.closePath();ctx.fill();}
  else if(shape==='sniper'){ctx.beginPath();ctx.roundRect(-12,-9,24,18,3);ctx.fill();}
  else{ctx.beginPath();ctx.roundRect(-15,-12,30,24,4);ctx.fill();}
  // barrel
  ctx.fillStyle=t.color;ctx.shadowBlur=8;
  if(shape==='sniper'){ctx.fillRect(10,-2,28,4);ctx.fillStyle='#fff';ctx.shadowBlur=14;ctx.fillRect(36,-2.5,5,5);}
  else if(shape==='heavy'){ctx.fillRect(10,-4.5,22,9);ctx.fillStyle='#fff';ctx.shadowBlur=14;ctx.fillRect(30,-3,4,6);}
  else{ctx.fillRect(8,-3.5,20,7);ctx.fillStyle='#fff';ctx.shadowBlur=14;ctx.fillRect(26,-2.5,4,5);}
  // turret
  ctx.shadowColor=t.color;ctx.shadowBlur=10;ctx.fillStyle=t.color;ctx.beginPath();ctx.arc(0,0,9,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.2)';ctx.beginPath();ctx.arc(-2,-2,5,0,Math.PI*2);ctx.fill();
  // treads
  ctx.shadowBlur=0;ctx.fillStyle='rgba(0,0,0,0.65)';
  const tw=shape==='heavy'?22:shape==='speedy'?10:18;
  [-9,0,9].forEach(x=>{ctx.fillRect(x-3.5,-tw,7,5);ctx.fillRect(x-3.5,tw-5,7,5);});
  ctx.restore();

  // â”€â”€ NAME TAG â€” big, solid pill, always readable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.save();
  ctx.globalAlpha=isGhost?0.35:1;
  ctx.textAlign='center';

  const name=(isMe?'â–¶ ':'')+t.nick;
  ctx.font='bold 15px Arial,sans-serif';
  const nameW=ctx.measureText(name).width;
  const padX=12,padY=5,tagH=22;
  const tagW=nameW+padX*2;
  const tagX=t.x-tagW/2, tagY=t.y-58;

  // solid dark background pill
  ctx.fillStyle='rgba(0,0,0,0.88)';
  ctx.beginPath();ctx.roundRect(tagX,tagY,tagW,tagH,6);ctx.fill();

  // colored outline
  ctx.strokeStyle=isMe?'rgba(255,255,255,0.9)':t.color;
  ctx.lineWidth=isMe?2:1.5;
  ctx.shadowColor=isMe?'#fff':t.color;ctx.shadowBlur=6;
  ctx.beginPath();ctx.roundRect(tagX,tagY,tagW,tagH,6);ctx.stroke();
  ctx.shadowBlur=0;

  // name text â€” white for self, tank color for others
  ctx.fillStyle=isMe?'#ffffff':t.color;
  ctx.shadowColor=isMe?'rgba(255,255,255,0.6)':t.color;
  ctx.shadowBlur=4;
  ctx.fillText(name, t.x, tagY+tagH-5);
  ctx.shadowBlur=0;

  // hp bar underneath
  const bw=Math.max(tagW,52),bh=6,bx=t.x-bw/2,by=tagY+tagH+3;
  const maxHp=t.tankDef?.hp||100;
  ctx.fillStyle='rgba(0,0,0,0.8)';ctx.fillRect(bx-1,by-1,bw+2,bh+2);
  ctx.fillStyle='rgba(255,255,255,0.08)';ctx.fillRect(bx,by,bw,bh);
  const pct=Math.max(0,(t.hp||0))/maxHp;
  const bc=pct>.5?t.color:pct>.25?'#ffaa00':'#ff2020';
  ctx.fillStyle=bc;ctx.shadowColor=bc;ctx.shadowBlur=4;ctx.fillRect(bx,by,bw*pct,bh);
  ctx.restore();
}

function drawMinimap(){
  const mw=mm.width,mh=mm.height;
  mctx.fillStyle='rgba(0,0,0,0.88)';mctx.fillRect(0,0,mw,mh);
  mctx.fillStyle='#1e1e30';
  walls.forEach(w=>{mctx.fillRect(w.x/MAP_W*mw,w.y/MAP_H*mh,Math.max(1,w.w/MAP_W*mw),Math.max(1,w.h/MAP_H*mh));});
  mctx.strokeStyle='rgba(255,255,255,0.14)';mctx.lineWidth=1;
  mctx.strokeRect(camX/MAP_W*mw,camY/MAP_H*mh,VP_W/MAP_W*mw,VP_H/MAP_H*mh);
  // Only show MY dot
  if(myTank&&myTank.alive){
    mctx.fillStyle=myTank.color;mctx.shadowColor=myTank.color;mctx.shadowBlur=6;
    mctx.beginPath();mctx.arc(myTank.x/MAP_W*mw,myTank.y/MAP_H*mh,4,0,Math.PI*2);mctx.fill();
  }
  mctx.shadowBlur=0;
}

buildWalls();
function loop(){update();draw();requestAnimationFrame(loop);}
loop();
</script>
</body>
</html>
